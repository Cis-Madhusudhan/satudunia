// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax
(function(a){a.fn.pjax=function(b,c){c?c.container=b:c=a.isPlainObject(b)?b:{container:b};if(typeof c.container!="string"||typeof c.container!="function")throw"pjax container must be a string selector!";return this.live("click",function(b){if(b.which>1||b.metaKey)return!0;var d={url:this.href,container:a(this).attr("data-pjax"),clickedElement:a(this)};a.pjax(a.extend({},d,c)),b.preventDefault()})},a.pjax=function(b){var c=a(b.container),d=b.success||a.noop;delete b.success;if(typeof b.container!="string")throw"pjax container must be a string selector!";var e={timeout:650,push:!0,replace:!1,data:{_pjax:!0},type:"GET",dataType:"html",beforeSend:function(a){c.trigger("start.pjax"),a.setRequestHeader("X-PJAX","true")},error:function(){window.location=b.url},complete:function(){c.trigger("end.pjax")},success:function(e){if(!a.trim(e)||/<html/i.test(e)){e=e.replace(/\n|\r/g,"");var f=e.match("<s*titles*>(.+)</s*titles*>");f&&f[1]&&(document.title=f[1]),f=e.match("<s*body[^>]*>(.+)</s*bodys*>"),f&&f[1]?a("body").html(f[1]):window.location=url}else c.html(e);var g=document.title,h=a.trim(c.find("title").remove().text());h&&(document.title=h);var i={pjax:b.container,timeout:b.timeout},j=a.param(b.data);j!="_pjax=true"&&(i.url=b.url+(/\?/.test(b.url)?"&":"?")+j),b.replace?window.history.replaceState(i,document.title,b.url):b.push&&(a.pjax.active||(window.history.replaceState(a.extend({},i,{url:null}),g),a.pjax.active=!0),window.history.pushState(i,document.title,b.url)),(b.replace||b.push)&&window._gaq&&_gaq.push(["_trackPageview"]);var k=window.location.hash.toString();k!==""&&(window.location.hash="",window.location.hash=k),d.apply(this,arguments)}};b=a.extend(!0,{},e,b),a.isFunction(b.url)&&(b.url=b.url());var f=a.pjax.xhr;return f&&f.readyState<4&&(f.onreadystatechange=a.noop,f.abort()),a.pjax.xhr=a.ajax(b),a(document).trigger("pjax",a.pjax.xhr,b),a.pjax.xhr};var b="state"in window.history,c=location.href;a(window).bind("popstate",function(d){var e=!b&&location.href==c;b=!0;if(e)return;var f=d.state;if(f&&f.pjax){var g=f.pjax;a(g+"").length?a.pjax({url:f.url||location.href,container:g,push:!1,timeout:f.timeout}):window.location=location.href}}),a.inArray("state",a.event.props)<0&&a.event.props.push("state"),a.support.pjax=window.history&&window.history.pushState,a.support.pjax||(a.pjax=function(b){window.location=a.isFunction(b.url)?b.url():b.url},a.fn.pjax=function(){return this})})(jQuery);