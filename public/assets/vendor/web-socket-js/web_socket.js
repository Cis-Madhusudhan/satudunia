// Copyright: Hiroshi Ichikawa <http://gimite.net/en/>
// License: New BSD License
// Reference: http://dev.w3.org/html5/websockets/
// Reference: http://tools.ietf.org/html/draft-hixie-thewebsocketprotocol
(function(){function b(){}if(window.WebSocket)return;var a=window.console;a||(a={log:function(){},error:function(){}});if(!swfobject.hasFlashPlayerVersion("9.0.0")){a.error("Flash Player is not installed.");return}location.protocol=="file:"&&a.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),WebSocket=function(a,b,c,d,e){var f=this;f.readyState=WebSocket.CONNECTING,f.bufferedAmount=0,setTimeout(function(){WebSocket.__addTask(function(){f.__createFlash(a,b,c,d,e)})},1)},WebSocket.prototype.__createFlash=function(b,c,d,e,f){var g=this;g.__flash=WebSocket.__flash.create(b,c,d||null,e||0,f||null),g.__flash.addEventListener("open",function(b){try{g.readyState=g.__flash.getReadyState(),g.__timer&&clearInterval(g.__timer),window.opera&&(g.__timer=setInterval(function(){g.__handleMessages()},500)),g.onopen&&g.onopen()}catch(c){a.error(c.toString())}}),g.__flash.addEventListener("close",function(b){try{g.readyState=g.__flash.getReadyState(),g.__timer&&clearInterval(g.__timer),g.onclose&&g.onclose()}catch(c){a.error(c.toString())}}),g.__flash.addEventListener("message",function(){try{g.__handleMessages()}catch(b){a.error(b.toString())}}),g.__flash.addEventListener("error",function(b){try{g.__timer&&clearInterval(g.__timer),g.onerror&&g.onerror()}catch(c){a.error(c.toString())}}),g.__flash.addEventListener("stateChange",function(b){try{g.readyState=g.__flash.getReadyState(),g.bufferedAmount=b.getBufferedAmount()}catch(c){a.error(c.toString())}})},WebSocket.prototype.send=function(a){this.__flash&&(this.readyState=this.__flash.getReadyState());if(!this.__flash||this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";var b=this.__flash.send(encodeURIComponent(a));return b<0?!0:(this.bufferedAmount=b,!1)},WebSocket.prototype.close=function(){var a=this;if(!a.__flash)return;a.readyState=a.__flash.getReadyState();if(a.readyState==WebSocket.CLOSED||a.readyState==WebSocket.CLOSING)return;a.__flash.close(),a.readyState=WebSocket.CLOSED,a.__timer&&clearInterval(a.__timer),a.onclose&&setTimeout(a.onclose,1)},WebSocket.prototype.addEventListener=function(a,b,c){"__events"in this||(this.__events={}),a in this.__events||(this.__events[a]=[],"function"==typeof this["on"+a]&&(this.__events[a].defaultHandler=this["on"+a],this["on"+a]=this.__createEventHandler(this,a))),this.__events[a].push(b)},WebSocket.prototype.removeEventListener=function(a,b,c){"__events"in this||(this.__events={});if(!(a in this.__events))return;for(var d=this.__events.length;d>-1;--d)if(b===this.__events[a][d]){this.__events[a].splice(d,1);break}},WebSocket.prototype.dispatchEvent=function(a){if(!("__events"in this))throw"UNSPECIFIED_EVENT_TYPE_ERR";if(!(a.type in this.__events))throw"UNSPECIFIED_EVENT_TYPE_ERR";for(var b=0,c=this.__events[a.type].length;b<c;++b){this.__events[a.type][b](a);if(a.cancelBubble)break}!1!==a.returnValue&&"function"==typeof this.__events[a.type].defaultHandler&&this.__events[a.type].defaultHandler(a)},WebSocket.prototype.__handleMessages=function(){var b=this.__flash.readSocketData();for(var c=0;c<b.length;c++){var d=decodeURIComponent(b[c]);try{if(this.onmessage){var e;window.MessageEvent&&!window.opera?(e=document.createEvent("MessageEvent"),e.initMessageEvent("message",!1,!1,d,null,null,window,null)):e={data:d},this.onmessage(e)}}catch(e){a.error(e.toString())}}},WebSocket.prototype.__createEventHandler=function(a,c){return function(d){var e=new b;e.initEvent(c,!0,!0),e.target=e.currentTarget=a;for(var f in d)e[f]=d[f];a.dispatchEvent(e,arguments)}},b.prototype.cancelable=!0,b.prototype.cancelBubble=!1,b.prototype.preventDefault=function(){this.cancelable&&(this.returnValue=!1)},b.prototype.stopPropagation=function(){this.cancelBubble=!0},b.prototype.initEvent=function(a,b,c){this.type=a,this.cancelable=c,this.timeStamp=new Date},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__tasks=[],WebSocket.__initialize=function(){WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation);if(!window.WEB_SOCKET_SWF_LOCATION){a.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var b=document.createElement("div");b.id="webSocketContainer",b.style.position="absolute",WebSocket.__isFlashLite()?(b.style.left="0px",b.style.top="0px"):(b.style.left="-100px",b.style.top="-100px");var c=document.createElement("div");c.id="webSocketFlash",b.appendChild(c),document.body.appendChild(b),swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","9.0.0",null,{bridgeName:"webSocket"},{hasPriority:!0,allowScriptAccess:"always"},null,function(b){b.success||a.error("[WebSocket] swfobject.embedSWF failed")}),FABridge.addInitializationCallback("webSocket",function(){try{WebSocket.__flash=FABridge.webSocket.root(),WebSocket.__flash.setCallerUrl(location.href),WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var b=0;b<WebSocket.__tasks.length;++b)WebSocket.__tasks[b]();WebSocket.__tasks=[]}catch(c){a.error("[WebSocket] "+c.toString())}})},WebSocket.__addTask=function(a){WebSocket.__flash?a():WebSocket.__tasks.push(a)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var a=window.navigator.mimeTypes["application/x-shockwave-flash"];return!a||!a.enabledPlugin||!a.enabledPlugin.filename?!1:a.enabledPlugin.filename.match(/flashlite/i)?!0:!1},window.webSocketLog=function(b){a.log(decodeURIComponent(b))},window.webSocketError=function(b){a.error(decodeURIComponent(b))},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||(window.addEventListener?window.addEventListener("load",WebSocket.__initialize,!1):window.attachEvent("onload",WebSocket.__initialize))})();