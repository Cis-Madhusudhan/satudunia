/*
 * Copyright (c) 2009 Benoit Chesneau <benoitc@e-engura.org>
 *
 * Permission to use, copy, modify, and distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.

 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 * Some code borrowed to livepipe :
 * Copyright 2008 PersonalGrid Corporation <http://personalgrid.com/>
 * License MIT
 * Url: http://livepipe.net/control/textarea
 *
 */
(function(a){function d(a,b){return this instanceof d?this.init(a,b):d(a,b)}function e(a,b){return this instanceof e?this.init(a,b):e(a,b)}var b=function(a){if(!a)return[];if(a.toArray)return a.toArray();var b=[];for(var c=0;c<a.length;c++)b.push(a[c]);return b};Function.prototype.ebind=function(){var a=this,c=b(arguments),d=c.shift();return function(){return a.apply(d,c.concat(b(arguments)))}},Function.prototype.bindAsEventListener=function(){var a=this,c=b(arguments),d=c.shift();return function(b){return a.apply(d,[b||window.event].concat(c))}},K=function(a){return a},Array.prototype.collect=function(b,c){b=b||K;var d=[];return a(this).each(function(a,e){d.push(b.call(c,e,a))}),d},a.fn.TextArea=function(b){b=b||{};var c={tab_spacing:!0,tab_char:4,lineHeight:16,change:null,resizeable:!0,resizeClassName:"resizeHandle"},b=a.extend(c,b);return this.each(function(){new d(this,b)})},a.extend(d.prototype,{onChangeTimeoutLength:500,init:function(b,c){var d=this;this.el=a(b),this.element=this.el[0],this.options=c,this.toolbar=c.toolbar,this._change_callback=c.change,a.extend(b,{textarea:this});var e=navigator.userAgent.toLowerCase();this.isWebkit=e.indexOf("webkit")>=0,this.isChrome=e.indexOf("chrome")>=0,this.isOpera=e.indexOf("opera")>=0,this.options.resizeable&&!this.isWebkit&&(resizeHandle=a('<div class="'+this.options.resizeClassName+'"></div>').insertAfter(this.el).bind("mousedown",function(b){var c=d.el.height(),e=b.clientY,f,g;f=function(a){return d.el.css("height",Math.max(20,a.clientY+c-e)+"px"),!1},g=function(b){return a("html").unbind("mousemove",f).unbind("mouseup",g),!1},a("html").bind("mousemove",f).bind("mouseup",g)})),this.lastSelection={},this.isWebkit&&(this.options.tab_char+=1);if(this.options.tab_spacing){this.tabulation="";for(var f=0;f<this.options.tab_char;f++)this.tabulation+=" "}else this.tabulation="	";this.tab_detected=!1,!document.selection||(this.element.selectionStart=this.element.selectionEnd=0),this.el.keydown(this.handleKey.ebind(this));var d=this;this.doOnChange=function(a){d._change_callback&&d._change_callback(d.element.value);return},this.el.keyup(this.doOnChange),this.el.bind("paste",this.doOnChange),this.el.bind("input",this.doOnChange),!document.selection||(this.el.bind("mouseup",this.saveRange.bindAsEventListener(this)),this.el.bind("keyup",this.saveRange.bindAsEventListener(this))),this.isOpera&&this.el.bind("blur",function(a){d.lastKey&&d.lastKey==9&&d.el.focus()})},saveRange:function(){this.range=document.selection.createRange()},getValue:function(){return this.element.value},getSelection:function(){return document.selection?document.selection.createRange().text:this.element.setSelectionRange?this.element.value.substring(this.element.selectionStart,this.element.selectionEnd):!1},replaceSelection:function(a){var b=this.element.scrollTop;if(!document.selection){if(!!this.element.setSelectionRange){var d=this.element.selectionStart;this.element.value=this.element.value.substring(0,d)+a+this.element.value.substring(this.element.selectionEnd),this.element.setSelectionRange(d+a.length,d+a.length)}}else{this.element.focus();var c=this.range?this.range:document.selection.createRange();c.text=a,c.select()}this.doOnChange(),this.element.focus(),this.element.scrollTop=b},wrapSelection:function(a,b){this.replaceSelection(a+this.getSelection()+b)},insertBeforeSelection:function(a){this.replaceSelection(a+this.getSelection())},insertAfterSelection:function(a){this.replaceSelection(this.getSelection()+a)},collectFromEachSelectedLine:function(a,c,d){this.replaceSelection((c||"")+b(this.getSelection().split("\n")).collect(a).join("\n")+(d||""))},insertBeforeEachSelectedLine:function(a,b,c){this.collectFromEachSelectedLine(function(a){},b,c)},handleKey:function(a){return c=a.charCode||a.keyCode,this.lastKey=c,c==9?(this.tab_selection(),window.event&&(a.returnValue=!1),a.preventDefault(),a.stopPropagation(),!1):(c==13||c==10)&&!this.isOpera&&this.do_enter()?(window.event&&(a.returnValue=!1),a.preventDefault(),a.stopPropagation(),!1):!0},tab_selection:function(){if(this._is_tabbing)return;this._is_tabbing=!0,!!document.selection&&!this.isOpera&&this._getIESelection(),this._tab_detected||this._detect_tab();var a=this.element.selectionStart,b=this.element.selectionEnd,c=this.element.value.substring(a,b),d=this.el.scrollTop(),e=this.el.scrollLeft(),f=a,g=b;c.length==0?(this.element.value=this.element.value.substr(0,a)+this.tabulation+this.element.value.substr(b),f=a+this.tabulation.length,g=f):(a=Math.max(0,this.element.value.substr(0,a).lastIndexOf("\n")+1),endText=this.element.value.substr(b),startText=this.element,value.substr(0,a),tmp=c.split("\n"),c=this.tabulation+tmp.join("\n"+this.tabulation),this.el.val(startText+c+endText),f=a,g=this.element.value.indexOf("\n",startText.length+c.length),g==-1&&(g=this.element.value.length)),this.element.selectionStart=f,this.element.selectionEnd=g,!!document.selection&&!this.isOpera?(this._setIESelection(),setTimeout(function(){self._is_tabbing=!1},100),this._is_tabbing=!1):this._is_tabbing=!1,this.el.scrollTop(d),this.el.scrollLeft(e)},do_enter:function(){!!document.selection&&!this.isOpera&&this._getIESelection();var a=this.el.scrollTop(),b=this.el.scrollLeft(),c=this.element.selectionStart,d=this.element.selectionEnd,e=Math.max(0,this.element.value.substring(0,c).lastIndexOf("\n")+1),f=this.element.value.substring(e,c);if(f.match(/^[ \t]+$/mg,""))return!1;var g=f.replace(/^([ \t]*).*/gm,"$1");return g=="\n"||g=="\r\n"?!1:(g=g.replace(/\r?\n/g,""),document.selection?g="\r\n"+g:g="\n"+g,this.element.value=this.element.value.substring(0,c)+g+this.element.value.substring(d),this.area_select(c+g.length,0),this.el.scrollTop(a),this.el.scrollLeft(b),!0)},area_select:function(a,b){value=this.el.val(),a=Math.max(0,Math.min(value.length,a)),end=Math.max(a,Math.min(value.length,a+b)),!!document.selection&&!this.isOpera?(this.element.selectionStart=a,this.element.selectionEnd=end,this._setIESelection()):this.isOpera?(this.element.setSelectionRange(0,0),this.element.setSelectionRange(end,end)):this.element.setSelectionRange(a,end)},_detect_tab:function(){if(this.element.value.indexOf("	")>0)this.tabulation="	";else{this.tabulation="";for(var a=0;a<this.options.tab_char;a++)this.tabulation+=" "}this._tab_detected=!0},_getIESelection:function(){this.el.focus();var a=this.elelement.createTextRange(),b=a.duplicate();a.moveToBookmark(document.selection.createRange().getBookmark()),a.moveEnd("character",this.element.value.length),this.el.selectionStart=this.element.value.length-a.text.length,b.moveToBookmark(document.selection.createRange().getBookmark()),b.moveStart("character",-this.element.value.length),this.el.selectionEnd=b.text.length,this.element.selectionEnd<this.element.selectionStart&&(this.element.selectionEnd=this.element.selectionStart)},_setIESelection:function(){var a=this.element.value.substr(0,this.element.selectionStart).split("\n").length-1,b=this.element.value.substr(0,this.element.selectionEnd).split("\n").length-1,c=document.selection.createRange();c.moveToElementText(this.element),c.setEndPoint("EndToStart",c),c.collapse(!0),c.moveStart("character",this.element.selectionStart-a),c.moveEnd("character",this.element.selectionEnd-b-(this.element.selectionStart-a)),c.select()}}),a.Toolbar=function(b,c){c=c||{};var d={className:null},c=a.extend(d,c);return new e(b,c)},a.extend(e.prototype,{init:function(b,c){this.textarea=b,this.options=c,this.containers=[];var d=this.options.className||"toolbar",e=this;this.textarea.each(function(){var b=a(document.createElement("ul"));b.addClass(d),b.insertBefore(this);var c=this;e.containers.push({container:b,textarea:c})})},attachButton:function(b,c,d){b.onclick=function(){return!1};var e=c.textarea;a(b).bind("click",d.bindAsEventListener(e))},addButton:function(b,c,d){for(var e=0;e<this.containers.length;e++){var f=this.containers[e],g=document.createElement("li"),h=document.createElement("a");h.href="#",this.attachButton(h,f.textarea,c),g.appendChild(h);if("className"in d){var i=d.className;d.className=null,delete d.className,a(h).addClass(i)}a.extend(h,d||{});if(b){var j=document.createElement("span");j.innerHTML=b,h.appendChild(j),h.setAttribute("alt",b),h.setAttribute("title",b)}f.container[0].appendChild(g)}}})})(jQuery);